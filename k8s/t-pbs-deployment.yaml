apiVersion: v1
kind: Service
metadata:
  name: t-pbs-server
  namespace: default
spec:
  selector:
    app: t-pbs-server
  ports:
  - name: tcp-8888
    port: 8888
    targetPort: 8888
    protocol: TCP
  type: ClusterIP

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: t-pbs-server
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: t-pbs-server
  template:
    metadata:
      labels:
        app: t-pbs-server
    spec:
      nodeSelector:
        "intel.feature.node.kubernetes.io/sgx": "true"
      containers:
      - name: t-pbs-server
        image: t-pbs-server:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8888
        resources:
          limits:
            sgx.intel.com/epc: 64Mi
          requests:
            sgx.intel.com/epc: 64Mi
        securityContext:
          readOnlyRootFilesystem: false
        command:
        - sh
        - -c
        - |
          echo "Starting T-PBS Server..."
          cd /app/bin
          ./appserver --pageSize 1024 --numThreads 2 --managerCap 100 --logDir /tmp/log --logLevel 1
        volumeMounts:
        - name: sgx-aesmd-socket
          mountPath: /var/run/aesmd
        - name: sgx-enclave
          mountPath: /dev/sgx_enclave
        - name: sgx-provision
          mountPath: /dev/sgx_provision
        - name: log-volume
          mountPath: /tmp/log
        - name: test-data
          mountPath: /app/test_data
      volumes:
      - name: sgx-aesmd-socket
        hostPath:
          path: /var/run/aesmd
      - name: sgx-enclave
        hostPath:
          path: /dev/sgx_enclave
      - name: sgx-provision
        hostPath:
          path: /dev/sgx_provision
      - name: log-volume
        emptyDir: {}
      - name: test-data
        emptyDir: {}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: t-pbs-client
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: t-pbs-client
  template:
    metadata:
      labels:
        app: t-pbs-client
    spec:
      nodeSelector:
        "intel.feature.node.kubernetes.io/sgx": "true"
      containers:
      - name: t-pbs-client
        image: t-pbs-client:latest
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            sgx.intel.com/epc: 64Mi
          requests:
            sgx.intel.com/epc: 64Mi
        securityContext:
          readOnlyRootFilesystem: false
        command:
        - sh
        - -c
        - |
          echo "Waiting for server to be ready..."
          sleep 10
          echo "Starting T-PBS Client..."
          cd /app/bin
          ./apprequester --maxId 20 --reqNum 5 --pageSize 1024 --logDir /tmp/log --logLevel 1
        volumeMounts:
        - name: sgx-aesmd-socket
          mountPath: /var/run/aesmd
        - name: sgx-enclave
          mountPath: /dev/sgx_enclave
        - name: sgx-provision
          mountPath: /dev/sgx_provision
        - name: log-volume
          mountPath: /tmp/log
        - name: test-data
          mountPath: /app/test_data
        env:
        - name: T_PBS_SERVER_ADDR
          value: "t-pbs-server"
        - name: T_PBS_SERVER_PORT
          value: "8888"
      volumes:
      - name: sgx-aesmd-socket
        hostPath:
          path: /var/run/aesmd
      - name: sgx-enclave
        hostPath:
          path: /dev/sgx_enclave
      - name: sgx-provision
        hostPath:
          path: /dev/sgx_provision
      - name: log-volume
        emptyDir: {}
      - name: test-data
        emptyDir: {}

---
apiVersion: batch/v1
kind: Job
metadata:
  name: t-pbs-user
  namespace: default
spec:
  backoffLimit: 1
  template:
    spec:
      nodeSelector:
        "intel.feature.node.kubernetes.io/sgx": "true"
      restartPolicy: Never
      containers:
      - name: t-pbs-user
        image: t-pbs-user:latest
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            sgx.intel.com/epc: 64Mi
          requests:
            sgx.intel.com/epc: 64Mi
        securityContext:
          readOnlyRootFilesystem: false
        command:
        - sh
        - -c
        - |
          echo "Starting T-PBS User data insertion..."
          cd /app/bin
          ./appinsertor -n 10 --logDir /tmp/log/user/ --logLevel 1
        volumeMounts:
        - name: sgx-aesmd-socket
          mountPath: /var/run/aesmd
        - name: sgx-enclave
          mountPath: /dev/sgx_enclave
        - name: sgx-provision
          mountPath: /dev/sgx_provision
        - name: log-volume
          mountPath: /tmp/log
        - name: test-data
          mountPath: /app/test_data
        env:
        - name: T_PBS_SERVER_ADDR
          value: "t-pbs-server"
        - name: T_PBS_SERVER_PORT
          value: "8888"
      volumes:
      - name: sgx-aesmd-socket
        hostPath:
          path: /var/run/aesmd
      - name: sgx-enclave
        hostPath:
          path: /dev/sgx_enclave
      - name: sgx-provision
        hostPath:
          path: /dev/sgx_provision
      - name: log-volume
        emptyDir: {}
      - name: test-data
        emptyDir: {}
